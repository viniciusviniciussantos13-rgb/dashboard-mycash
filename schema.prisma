generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  avatarUrl String?  @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  familyMembers      FamilyMember[]
  accounts           Account[]
  transactions       Transaction[]
  categories         Category[]
  recurringTemplates RecurringTransaction[]

  @@map("users")
}

model FamilyMember {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  name          String
  role          String
  avatarUrl     String?  @map("avatar_url")
  monthlyIncome Decimal  @default(0) @map("monthly_income") @db.Decimal(12, 2)
  color         String   @default("#3247FF")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountsAsHolder      Account[]              @relation("AccountHolder")
  transactions          Transaction[]          @relation("TransactionMember")
  recurringTransactions RecurringTransaction[] @relation("RecurringMember")

  @@index([userId])
  @@map("family_members")
}

model Category {
  id        String          @id @default(uuid())
  userId    String          @map("user_id")
  name      String
  icon      String          @default("ðŸ“Œ")
  type      TransactionType
  color     String          @default("#3247FF")
  isActive  Boolean         @default(true) @map("is_active")
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")

  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions          Transaction[]
  recurringTransactions RecurringTransaction[]

  @@index([userId, type])
  @@map("categories")
}

model Account {
  id         String      @id @default(uuid())
  userId     String      @map("user_id")
  type       AccountType
  name       String
  bank       String
  lastDigits String?     @map("last_digits")
  holderId   String      @map("holder_id")
  balance    Decimal     @default(0) @db.Decimal(12, 2)
  creditLimit Decimal?   @map("credit_limit") @db.Decimal(12, 2)
  currentBill Decimal     @default(0) @map("current_bill") @db.Decimal(12, 2)
  dueDay      Int?       @map("due_day")
  closingDay  Int?       @map("closing_day")
  theme       String?    @default("black")
  logoUrl     String?    @map("logo_url")
  color       String     @default("#3247FF")
  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  holder                FamilyMember           @relation("AccountHolder", fields: [holderId], references: [id])
  transactions          Transaction[]
  recurringTransactions RecurringTransaction[]

  @@index([userId, type])
  @@index([holderId])
  @@map("accounts")
}

model Transaction {
  id          String          @id @default(uuid())
  userId      String          @map("user_id")
  type        TransactionType
  amount      Decimal         @db.Decimal(12, 2)
  description String
  date        DateTime        @db.Date
  categoryId  String?         @map("category_id")
  accountId   String?         @map("account_id")
  memberId    String?         @map("member_id")
  installmentNumber   Int?    @map("installment_number")
  totalInstallments   Int     @default(1) @map("total_installments")
  parentTransactionId String? @map("parent_transaction_id")
  isRecurring            Boolean @default(false) @map("is_recurring")
  recurringTransactionId String? @map("recurring_transaction_id")
  status TransactionStatus @default(COMPLETED)
  notes  String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user              User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  category          Category?             @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  account           Account?              @relation(fields: [accountId], references: [id], onDelete: SetNull)
  member            FamilyMember?         @relation("TransactionMember", fields: [memberId], references: [id], onDelete: SetNull)
  recurringTemplate RecurringTransaction? @relation(fields: [recurringTransactionId], references: [id], onDelete: SetNull)
  parentTransaction Transaction?  @relation("TransactionInstallments", fields: [parentTransactionId], references: [id], onDelete: Cascade)
  childTransactions Transaction[] @relation("TransactionInstallments")

  @@index([userId, date])
  @@index([categoryId])
  @@index([accountId])
  @@index([memberId])
  @@index([recurringTransactionId])
  @@index([parentTransactionId])
  @@index([status])
  @@map("transactions")
}

model RecurringTransaction {
  id          String          @id @default(uuid())
  userId      String          @map("user_id")
  type        TransactionType @default(EXPENSE)
  amount      Decimal         @db.Decimal(12, 2)
  description String
  categoryId  String?         @map("category_id")
  accountId   String?         @map("account_id")
  memberId    String?         @map("member_id")
  frequency  RecurrenceFrequency
  dayOfMonth Int?             @map("day_of_month")
  dayOfWeek  Int?             @map("day_of_week")
  startDate  DateTime         @map("start_date") @db.Date
  endDate    DateTime?        @map("end_date") @db.Date
  isActive  Boolean  @default(true) @map("is_active")
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user                  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  category              Category?      @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  account               Account?       @relation(fields: [accountId], references: [id], onDelete: SetNull)
  member                FamilyMember?  @relation("RecurringMember", fields: [memberId], references: [id], onDelete: SetNull)
  generatedTransactions Transaction[]

  @@index([userId, isActive])
  @@index([categoryId])
  @@index([accountId])
  @@map("recurring_transactions")
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum AccountType {
  CHECKING
  SAVINGS
  CREDIT_CARD
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum TransactionStatus {
  PENDING
  COMPLETED
}
